name: Installer Artifacts

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version tag (example: release-v1.0.0)"
        required: false
        default: ""
  push:
    tags:
      - "release-*"

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
    steps:
      - id: resolve
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            echo "version=${{ github.event.inputs.version }}" >> "$GITHUB_OUTPUT"
          elif [ "${GITHUB_REF_TYPE}" = "tag" ]; then
            echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          else
            echo "version=build-${GITHUB_RUN_NUMBER}" >> "$GITHUB_OUTPUT"
          fi

  windows:
    runs-on: windows-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Install NSIS
        run: choco install nsis --no-progress -y
      - name: Build Windows installer
        shell: pwsh
        run: |
          ./scripts/installer/build-windows-installer.ps1 -Version "${{ needs.prepare.outputs.version }}"
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: volta-windows
          path: dist/release/${{ needs.prepare.outputs.version }}/windows/**
          if-no-files-found: error

  macos:
    runs-on: macos-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build macOS pkg/dmg
        run: |
          bash packaging/macos/build-pkg.sh "${{ needs.prepare.outputs.version }}"
      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: volta-macos
          path: dist/release/${{ needs.prepare.outputs.version }}/macos/**
          if-no-files-found: error

  linux:
    runs-on: ubuntu-latest
    needs: prepare
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - name: Build Linux tarball
        run: |
          bash packaging/linux/build-tarball.sh "${{ needs.prepare.outputs.version }}" x86_64-unknown-linux-gnu
      - name: Build Linux deb
        run: |
          bash packaging/linux/build-deb.sh "${{ needs.prepare.outputs.version }}"
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: volta-linux
          path: dist/release/${{ needs.prepare.outputs.version }}/linux/**
          if-no-files-found: error

  bundle:
    runs-on: ubuntu-latest
    needs: [prepare, windows, macos, linux]
    steps:
      - uses: actions/checkout@v4
      - name: Download Windows artifacts
        uses: actions/download-artifact@v4
        with:
          name: volta-windows
          path: dist/release/${{ needs.prepare.outputs.version }}/windows
      - name: Download macOS artifacts
        uses: actions/download-artifact@v4
        with:
          name: volta-macos
          path: dist/release/${{ needs.prepare.outputs.version }}/macos
      - name: Download Linux artifacts
        uses: actions/download-artifact@v4
        with:
          name: volta-linux
          path: dist/release/${{ needs.prepare.outputs.version }}/linux
      - name: Assemble checksums and release notes
        run: |
          bash scripts/installer/assemble-release.sh "${{ needs.prepare.outputs.version }}"
      - name: Upload release bundle
        uses: actions/upload-artifact@v4
        with:
          name: volta-release-bundle-${{ needs.prepare.outputs.version }}
          path: dist/release/${{ needs.prepare.outputs.version }}/**
          if-no-files-found: error
