name: Nightly Quality

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

jobs:
  nightly-core:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Wave 1 gates
        run: bash scripts/ci/wave1_local_verify.sh

  nightly-cuda-infer:
    runs-on: ubuntu-latest
    needs: nightly-core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: CUDA inference verify
        run: bash scripts/ci/cuda_infer_verify.sh

  nightly-cuda-train:
    runs-on: ubuntu-latest
    needs: nightly-core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: CUDA training verify
        run: bash scripts/ci/cuda_train_verify.sh

  nightly-fuzz-heavy:
    runs-on: ubuntu-latest
    needs: nightly-core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Heavy fuzz
        run: bash scripts/ci/fuzz_heavy.sh

  nightly-soak-long:
    runs-on: ubuntu-latest
    needs: nightly-core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Long soak
        run: bash scripts/ci/soak_long.sh 10

  nightly-perf:
    runs-on: ubuntu-latest
    needs: nightly-core
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo
        uses: Swatinem/rust-cache@v2

      - name: Run nightly perf matrix
        run: bash scripts/ci/nightly_perf_matrix.sh

      - name: Build nightly quality report
        run: python scripts/ci/nightly_quality_report.py

      - name: Upload nightly artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: nightly-quality-artifacts
          path: benchmarks/reports/

  nightly-regression-issue:
    runs-on: ubuntu-latest
    if: failure()
    needs:
      - nightly-fuzz-heavy
      - nightly-soak-long
      - nightly-perf
    steps:
      - name: Open regression issue
        uses: actions/github-script@v7
        with:
          script: |
            const title = "Nightly quality regression detected";
            const body = [
              "Nightly quality workflow failed.",
              "",
              `Workflow run: ${context.serverUrl}/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`,
              "",
              "Please triage flaky tests, soak failures, and perf regressions.",
            ].join("\n");

            const issues = await github.paginate(github.rest.issues.listForRepo, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: "open",
              labels: "nightly-regression",
            });

            const existing = issues.find((issue) => issue.title === title);
            if (existing) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: existing.number,
                body,
              });
            } else {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title,
                body,
                labels: ["nightly-regression", "quality"],
              });
            }
