name: PR Gates

on:
  pull_request:
  workflow_dispatch:

jobs:
  detect-tier:
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.detect.outputs.tier }}
      changed: ${{ steps.detect.outputs.changed }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Detect impacted tier
        id: detect
        shell: bash
        run: |
          if [[ "${{ github.event_name }}" == "pull_request" ]]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="$(git rev-parse HEAD~1)"
          fi

          mapfile -t CHANGED < <(git diff --name-only "$BASE_SHA" "${{ github.sha }}")

          if [[ ${#CHANGED[@]} -eq 0 ]]; then
            python3 scripts/ci/detect_tiers.py > tier_output.txt
          else
            python3 scripts/ci/detect_tiers.py --paths "${CHANGED[@]}" > tier_output.txt
          fi

          cat tier_output.txt
          TIER=$(grep '^tier=' tier_output.txt | cut -d'=' -f2)
          CHANGED_FLAG=$(grep '^changed=' tier_output.txt | cut -d'=' -f2)

          echo "tier=$TIER" >> "$GITHUB_OUTPUT"
          echo "changed=$CHANGED_FLAG" >> "$GITHUB_OUTPUT"

  fmt:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: Format check
        run: cargo fmt --check

  clippy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: Clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

  test-debug:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: Debug tests
        run: cargo test

  test-release:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: Release tests
        run: cargo test --release

  cli-smoke:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: CLI smoke
        run: bash scripts/ci/cli_smoke.sh

  property-fast:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: Property fast checks
        run: cargo test --test property_fast

  cuda-infer-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: CUDA inference verify
        run: bash scripts/ci/cuda_infer_verify.sh

  cuda-train-verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Cache cargo
        uses: Swatinem/rust-cache@v2
      - name: CUDA training verify
        run: bash scripts/ci/cuda_train_verify.sh

  tier-a-guards:
    runs-on: ubuntu-latest
    needs: detect-tier
    if: needs.detect-tier.outputs.tier == 'A'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
      - name: Tier A governance checks
        run: |
          cargo test --test governance_docs_content
          cargo test --test governance_docs_presence
